<UserControl x:Class="MarkdownEditor2022.FloatingToolbar"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vs="clr-namespace:Microsoft.VisualStudio.Shell;assembly=Microsoft.VisualStudio.Shell.15.0"
             xmlns:imaging="clr-namespace:Microsoft.VisualStudio.Imaging;assembly=Microsoft.VisualStudio.Imaging"
             xmlns:catalog="clr-namespace:Microsoft.VisualStudio.Imaging;assembly=Microsoft.VisualStudio.ImageCatalog"
             x:Name="ToolbarRoot"
             Focusable="False"
             IsHitTestVisible="True"
             Background="Transparent"
             PreviewMouseMove="OnPreviewMouseMove">
    <UserControl.Resources>
        <Style x:Key="ToolbarButtonStyle" TargetType="Button">
            <Setter Property="Width" Value="24"/>
            <Setter Property="Height" Value="24"/>
            <Setter Property="Margin" Value="1"/>
            <Setter Property="Padding" Value="2"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Focusable" Value="False"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="2"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" 
                                        Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarMouseOverBackgroundGradientKey}}"/>
                                <Setter TargetName="border" Property="BorderBrush" 
                                        Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarHoverOverSelectedIconBorderKey}}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" 
                                        Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarMouseDownBackgroundGradientKey}}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Toggle button style for format buttons that can show checked/active state -->
        <Style x:Key="ToggleToolbarButtonStyle" TargetType="Button" BasedOn="{StaticResource ToolbarButtonStyle}">
            <Setter Property="Tag" Value="False"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="2"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <!-- Checked/active state (Tag="True") -->
                            <Trigger Property="Tag" Value="True">
                                <Setter TargetName="border" Property="Background" 
                                        Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarSelectedKey}}"/>
                                <Setter TargetName="border" Property="BorderBrush" 
                                        Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarSelectedBorderKey}}"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" 
                                        Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarMouseOverBackgroundGradientKey}}"/>
                                <Setter TargetName="border" Property="BorderBrush" 
                                        Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarHoverOverSelectedIconBorderKey}}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" 
                                        Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarMouseDownBackgroundGradientKey}}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SeparatorStyle" TargetType="Border">
            <Setter Property="Width" Value="1"/>
            <Setter Property="Margin" Value="4,4,4,4"/>
            <Setter Property="Background" Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarMenuSeparatorKey}}"/>
        </Style>

        <!-- Themed ContextMenu Style -->
        <Style x:Key="ThemedContextMenuStyle" TargetType="ContextMenu">
            <Setter Property="Background" Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarMenuBackgroundGradientKey}}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarMenuBorderKey}}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Foreground" Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarTextActiveKey}}"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="HasDropShadow" Value="True"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ContextMenu">
                        <Border x:Name="Border"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Padding="2"
                                SnapsToDevicePixels="True">
                            <StackPanel IsItemsHost="True" KeyboardNavigation.DirectionalNavigation="Cycle"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Themed MenuItem Style with custom template for full theming -->
        <Style x:Key="ThemedMenuItemStyle" TargetType="MenuItem">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarTextActiveKey}}"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="MinWidth" Value="100"/>
            <Setter Property="OverridesDefaultStyle" Value="True"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="MenuItem">
                        <Border x:Name="Border" 
                                Background="{TemplateBinding Background}" 
                                BorderThickness="0"
                                Padding="{TemplateBinding Padding}"
                                SnapsToDevicePixels="True">
                            <ContentPresenter ContentSource="Header" 
                                              VerticalAlignment="Center"
                                              HorizontalAlignment="Left"
                                              RecognizesAccessKey="True"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter TargetName="Border" Property="Background" 
                                        Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarMouseOverBackgroundGradientKey}}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Themed Separator Style for Menu -->
        <Style x:Key="ThemedMenuSeparatorStyle" TargetType="Separator">
            <Setter Property="Background" Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarMenuSeparatorKey}}"/>
            <Setter Property="Margin" Value="4,2"/>
            <Setter Property="Height" Value="1"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Separator">
                        <Border Background="{DynamicResource {x:Static vs:VsBrushes.CommandBarMenuSeparatorKey}}" 
                                Height="1" 
                                Margin="4,2"/>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="DropdownButtonStyle" TargetType="Button">
            <Setter Property="Height" Value="24"/>
            <Setter Property="MinWidth" Value="70"/>
            <Setter Property="Margin" Value="1"/>
            <Setter Property="Padding" Value="6,2"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Focusable" Value="False"/>
            <Setter Property="Foreground" Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarTextActiveKey}}"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="border" 
                                Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}"
                                CornerRadius="2"
                                Padding="{TemplateBinding Padding}">
                            <StackPanel Orientation="Horizontal">
                                <ContentPresenter VerticalAlignment="Center"/>
                                <Path x:Name="arrow" 
                                      Data="M 0 0 L 4 4 L 8 0 Z" 
                                      Fill="{DynamicResource {x:Static vs:VsBrushes.CommandBarTextActiveKey}}"
                                      Margin="6,0,0,0" 
                                      VerticalAlignment="Center"
                                      Width="8" Height="4"/>
                            </StackPanel>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" 
                                        Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarMouseOverBackgroundGradientKey}}"/>
                                <Setter TargetName="border" Property="BorderBrush" 
                                        Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarHoverOverSelectedIconBorderKey}}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Background" 
                                        Value="{DynamicResource {x:Static vs:VsBrushes.CommandBarMouseDownBackgroundGradientKey}}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <Border Background="{DynamicResource {x:Static vs:VsBrushes.CommandBarGradientKey}}"
            BorderBrush="{DynamicResource {x:Static vs:VsBrushes.CommandBarMenuBorderKey}}"
            BorderThickness="1"
            CornerRadius="3"
            Padding="2">
        <Border.Effect>
            <DropShadowEffect BlurRadius="8" ShadowDepth="2" Opacity="0.3" Direction="270"/>
        </Border.Effect>
        <StackPanel Orientation="Horizontal">
            <!-- Header Level Dropdown -->
            <Button x:Name="HeaderButton" 
                    Style="{StaticResource DropdownButtonStyle}"
                    ToolTip="Header Level"
                    Click="HeaderButton_Click">
                <Button.ContextMenu>
                    <ContextMenu x:Name="HeaderMenu" Placement="Bottom" Style="{StaticResource ThemedContextMenuStyle}">
                        <MenuItem Header="Paragraph" Tag="0" Click="HeaderMenuItem_Click" Style="{StaticResource ThemedMenuItemStyle}"/>
                        <Separator Style="{StaticResource ThemedMenuSeparatorStyle}"/>
                        <MenuItem Header="Heading 1" Tag="1" Click="HeaderMenuItem_Click" Style="{StaticResource ThemedMenuItemStyle}"/>
                        <MenuItem Header="Heading 2" Tag="2" Click="HeaderMenuItem_Click" Style="{StaticResource ThemedMenuItemStyle}"/>
                        <MenuItem Header="Heading 3" Tag="3" Click="HeaderMenuItem_Click" Style="{StaticResource ThemedMenuItemStyle}"/>
                        <MenuItem Header="Heading 4" Tag="4" Click="HeaderMenuItem_Click" Style="{StaticResource ThemedMenuItemStyle}"/>
                        <MenuItem Header="Heading 5" Tag="5" Click="HeaderMenuItem_Click" Style="{StaticResource ThemedMenuItemStyle}"/>
                        <MenuItem Header="Heading 6" Tag="6" Click="HeaderMenuItem_Click" Style="{StaticResource ThemedMenuItemStyle}"/>
                    </ContextMenu>
                </Button.ContextMenu>
                <TextBlock x:Name="HeaderText" Text="Paragraph" FontSize="11"/>
            </Button>

            <Border Style="{StaticResource SeparatorStyle}"/>

            <!-- Bold -->
            <Button x:Name="BoldButton" 
                    Style="{StaticResource ToggleToolbarButtonStyle}" 
                    ToolTip="Bold (Ctrl+B)"
                    Click="BoldButton_Click">
                <imaging:CrispImage Width="16" Height="16" Moniker="{x:Static catalog:KnownMonikers.Bold}"/>
            </Button>

            <!-- Italic -->
            <Button x:Name="ItalicButton" 
                    Style="{StaticResource ToggleToolbarButtonStyle}" 
                    ToolTip="Italic (Ctrl+I)"
                    Click="ItalicButton_Click">
                <imaging:CrispImage Width="16" Height="16" Moniker="{x:Static catalog:KnownMonikers.Italic}"/>
            </Button>

            <!-- Strikethrough -->
            <Button x:Name="StrikethroughButton" 
                    Style="{StaticResource ToggleToolbarButtonStyle}" 
                    ToolTip="Strikethrough"
                    Click="StrikethroughButton_Click">
                <imaging:CrispImage Width="16" Height="16" Moniker="{x:Static catalog:KnownMonikers.StrikeThrough}"/>
            </Button>

            <!-- Highlight/Mark -->
            <Button x:Name="HighlightButton" 
                    Style="{StaticResource ToggleToolbarButtonStyle}" 
                    ToolTip="Highlight (==text==)"
                    Click="HighlightButton_Click">
                <TextBlock Text="ab" FontSize="11" FontWeight="Bold" VerticalAlignment="Center" HorizontalAlignment="Center"
                           Foreground="{DynamicResource {x:Static vs:VsBrushes.CommandBarTextActiveKey}}">
                    <TextBlock.Background>
                        <SolidColorBrush Color="Yellow" Opacity="0.6"/>
                    </TextBlock.Background>
                </TextBlock>
            </Button>

            <!-- Subscript -->
            <Button x:Name="SubscriptButton" 
                    Style="{StaticResource ToggleToolbarButtonStyle}" 
                    ToolTip="Subscript (~text~)"
                    Click="SubscriptButton_Click">
                <TextBlock Text="X₂" FontSize="11" FontWeight="Bold" VerticalAlignment="Center" HorizontalAlignment="Center"
                           Foreground="{DynamicResource {x:Static vs:VsBrushes.CommandBarTextActiveKey}}"/>
            </Button>

            <!-- Superscript -->
            <Button x:Name="SuperscriptButton" 
                    Style="{StaticResource ToggleToolbarButtonStyle}" 
                    ToolTip="Superscript (^text^)"
                    Click="SuperscriptButton_Click">
                <TextBlock Text="X²" FontSize="11" FontWeight="Bold" VerticalAlignment="Center" HorizontalAlignment="Center"
                           Foreground="{DynamicResource {x:Static vs:VsBrushes.CommandBarTextActiveKey}}"/>
            </Button>

            <Border Style="{StaticResource SeparatorStyle}"/>

            <!-- Inline Code -->
            <Button x:Name="CodeButton" 
                    Style="{StaticResource ToggleToolbarButtonStyle}" 
                    ToolTip="Inline Code"
                    Click="CodeButton_Click">
                <imaging:CrispImage Width="16" Height="16" Moniker="{x:Static catalog:KnownMonikers.Code}"/>
            </Button>

            <!-- Link -->
            <Button x:Name="LinkButton" 
                    Style="{StaticResource ToolbarButtonStyle}" 
                    ToolTip="Insert Link"
                    Click="LinkButton_Click">
                <imaging:CrispImage Width="16" Height="16" Moniker="{x:Static catalog:KnownMonikers.Link}"/>
            </Button>

            <Border Style="{StaticResource SeparatorStyle}"/>

            <!-- Bullet List -->
            <Button x:Name="BulletListButton" 
                    Style="{StaticResource ToggleToolbarButtonStyle}" 
                    ToolTip="Bullet List"
                    Click="BulletListButton_Click">
                <imaging:CrispImage Width="16" Height="16" Moniker="{x:Static catalog:KnownMonikers.BulletList}"/>
            </Button>

            <!-- Numbered List -->
            <Button x:Name="NumberedListButton" 
                    Style="{StaticResource ToggleToolbarButtonStyle}" 
                    ToolTip="Numbered List"
                    Click="NumberedListButton_Click">
                <imaging:CrispImage Width="16" Height="16" Moniker="{x:Static catalog:KnownMonikers.OrderedList}"/>
            </Button>

            <!-- Task List -->
            <Button x:Name="TaskListButton" 
                    Style="{StaticResource ToggleToolbarButtonStyle}" 
                    ToolTip="Task List"
                    Click="TaskListButton_Click">
                <imaging:CrispImage Width="16" Height="16" Moniker="{x:Static catalog:KnownMonikers.CheckBoxList}"/>
            </Button>
        </StackPanel>
    </Border>
</UserControl>
